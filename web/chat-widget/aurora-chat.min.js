!function(){"use strict";const e=window.AURORA_CHAT_CONFIG||{},t=e.projectId||"aurora-viking-staff",a=e.apiKey||"AIzaSyDdCYDwnVw2IuWPaco_QUzGBMEz8ef2Zj4",n=(e.position,e.primaryColor,e.greeting||"Hey there! ‚ú® Need to reschedule, change your pickup spot, or have questions about your tour? Just drop your booking number and we'll sort it out!"),r=(e.offlineMessage,e.quickReplies||["Reschedule my tour","Change pickup location","Cancel booking","Tour info"]),o={apiKey:a,authDomain:`${t}.firebaseapp.com`,projectId:t},i=`https://us-central1-${t}.cloudfunctions.net`;let s=null,l=null,c=null,u=null,d=null,m=null,h=[],g=!1;const p=!0===window.AURORA_CHAT_EMBEDDED||"true"===new URLSearchParams(window.location.search).get("embedded");let v=0,f=null,b=null,y=null,w=null,k=!1,x=null,I=null,S=null,E=null,C=null,A=null;function T(e){return new Promise((t,a)=>{const n=document.createElement("script");n.src=e,n.onload=t,n.onerror=a,document.head.appendChild(n)})}async function L(){try{const e=await firebase.auth().signInAnonymously();return console.log("üîê Signed in anonymously:",e.user.uid),y=await e.user.getIdToken(),k=!0,firebase.auth().onIdTokenChanged(async e=>{e&&(y=await e.getIdToken(),console.log("üîÑ Auth token refreshed"))}),e.user.uid}catch(e){throw console.error("‚ùå Anonymous auth failed:",e),e}}async function M(e,t={}){const a={"Content-Type":"application/json",Authorization:`Bearer ${await async function(){k||await L();const e=firebase.auth().currentUser;return e&&(y=await e.getIdToken()),y}()}`,...t.headers};return fetch(e,{...t,headers:a})}async function V(){try{await async function(){"undefined"==typeof firebase&&(await T("https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"),await T("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"),await T("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js")),w=firebase.apps.length?firebase.app():firebase.initializeApp(o),console.log("üî• Firebase initialized with Firestore")}(),await L(),function(){try{const e=localStorage.getItem("aurora_chat_session");if(e){const t=JSON.parse(e);s=t.sessionId,l=t.conversationId,c=t.customerId,u=t.visitorName,d=t.visitorEmail,m=t.bookingRef,h=t.messages||[],b=t.lastMessageId}}catch(e){console.error("Error loading session:",e)}}(),F(),U(),s&&l&&J(),function(){if(!s)return;firebase.firestore().collection("website_sessions").doc(s).update({currentPageUrl:window.location.href,lastSeen:firebase.firestore.FieldValue.serverTimestamp(),isOnline:!0}).catch(e=>console.error("Error tracking page:",e))}(),console.log("üåå Aurora Chat Widget initialized with Firebase Auth")}catch(e){console.error("‚ùå Failed to initialize chat widget:",e),F(),U()}}function q(){try{localStorage.setItem("aurora_chat_session",JSON.stringify({sessionId:s,conversationId:l,customerId:c,visitorName:u,visitorEmail:d,bookingRef:m,messages:h.slice(-50),lastMessageId:b}))}catch(e){console.error("Error saving session:",e)}}function F(){x=document.createElement("div"),x.className="aurora-chat-widget",x.innerHTML=`\n      \x3c!-- Floating Button --\x3e\n      <button class="aurora-chat-button" aria-label="Open chat">\n        <svg viewBox="0 0 24 24">\n          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>\n        </svg>\n        <span class="aurora-chat-label">CHAT</span>\n        <span class="aurora-chat-badge" style="display: none;">0</span>\n      </button>\n      \n      \x3c!-- Chat Window --\x3e\n      <div class="aurora-chat-window">\n        \x3c!-- Header --\x3e\n        <div class="aurora-chat-header">\n          <div class="aurora-chat-logo">\n            <svg viewBox="0 0 24 24">\n              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n            </svg>\n          </div>\n          <div class="aurora-chat-header-info">\n            <div class="aurora-chat-title">Aurora Viking</div>\n            <div class="aurora-chat-subtitle">\n              <span class="aurora-chat-status"></span>\n              <span class="aurora-chat-status-text">We typically reply within minutes</span>\n            </div>\n          </div>\n          <button class="aurora-chat-close" aria-label="Close chat">\n            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <line x1="18" y1="6" x2="6" y2="18"></line>\n              <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n          </button>\n        </div>\n        \n        \x3c!-- Connection status --\x3e\n        <div class="aurora-chat-connection">\n          Connection lost. Reconnecting...\n        </div>\n        \n        \x3c!-- Messages --\x3e\n        <div class="aurora-chat-messages">\n          \x3c!-- Messages will be inserted here --\x3e\n        </div>\n        \n        \x3c!-- Visitor Info Form (collapsible) --\x3e\n        <div class="aurora-chat-visitor-form">\n          <button type="button" class="aurora-chat-visitor-toggle">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>\n              <circle cx="12" cy="7" r="4"/>\n            </svg>\n            <span class="aurora-visitor-toggle-text">Add your details (optional)</span>\n            <svg class="aurora-visitor-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <polyline points="6 9 12 15 18 9"/>\n            </svg>\n          </button>\n          <div class="aurora-chat-visitor-fields" style="display: none;">\n            <input type="text" class="aurora-visitor-input" id="aurora-visitor-name" placeholder="Your name" autocomplete="name"/>\n            <input type="email" class="aurora-visitor-input" id="aurora-visitor-email" placeholder="Email address" autocomplete="email"/>\n            <input type="text" class="aurora-visitor-input" id="aurora-visitor-booking" placeholder="Booking ref (e.g. AUR-12345)"/>\n          </div>\n        </div>\n        \n        \x3c!-- Quick replies (shown on empty state) --\x3e\n        <div class="aurora-chat-quick-replies">\n          ${r.map(e=>`<button class="aurora-chat-quick-reply">${e}</button>`).join("")}\n        </div>\n        \n        \x3c!-- Input area --\x3e\n        <div class="aurora-chat-input-container">\n          <form class="aurora-chat-input-form">\n            <div class="aurora-chat-input-wrapper">\n              <textarea \n                class="aurora-chat-input" \n                placeholder="Type your message..." \n                rows="1"\n                maxlength="2000"\n              ></textarea>\n            </div>\n            <button type="submit" class="aurora-chat-send" aria-label="Send message">\n              <svg viewBox="0 0 24 24">\n                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n              </svg>\n            </button>\n          </form>\n        </div>\n        \n        \x3c!-- Powered by --\x3e\n        <div class="aurora-chat-footer">\n          Powered by <a href="https://auroraviking.is" target="_blank" rel="noopener">Aurora Viking</a>\n        </div>\n      </div>\n    `,document.body.appendChild(x),I=x.querySelector(".aurora-chat-button"),S=x.querySelector(".aurora-chat-window"),E=x.querySelector(".aurora-chat-messages"),C=x.querySelector(".aurora-chat-input"),A=x.querySelector(".aurora-chat-badge"),p&&(x.classList.add("embedded"),I.style.display="none",S.classList.add("open"),x.querySelector(".aurora-chat-close").style.display="none",g=!0,console.log("üåå Aurora Chat running in embedded mode")),function(){I.addEventListener("click",D),x.querySelector(".aurora-chat-close").addEventListener("click",B);x.querySelector(".aurora-chat-input-form").addEventListener("submit",$),C.addEventListener("input",N),C.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),$(e))}),x.querySelectorAll(".aurora-chat-quick-reply").forEach(e=>{e.addEventListener("click",()=>{C.value=e.textContent,$(new Event("submit"))})});const e=x.querySelector(".aurora-chat-visitor-toggle"),t=x.querySelector(".aurora-chat-visitor-fields"),a=x.querySelector(".aurora-visitor-chevron");e.addEventListener("click",()=>{const e="none"===t.style.display;t.style.display=e?"flex":"none",a.style.transform=e?"rotate(180deg)":"rotate(0deg)"}),x.querySelector("#aurora-visitor-name").addEventListener("change",e=>{u=e.target.value.trim()||null,q()}),x.querySelector("#aurora-visitor-email").addEventListener("change",e=>{d=e.target.value.trim()||null,q()}),x.querySelector("#aurora-visitor-booking").addEventListener("change",e=>{m=e.target.value.trim()||null,q()}),document.addEventListener("visibilitychange",()=>{!document.hidden&&g&&j()})}(),H()}function U(){if(document.getElementById("aurora-chat-styles"))return;const e=document.createElement("link");e.id="aurora-chat-styles",e.rel="stylesheet",e.href=`https://${t}.web.app/chat-widget/aurora-chat.css`,document.head.appendChild(e)}function D(){g?B():_()}function _(){g=!0,S.classList.add("open"),I.classList.add("open"),j(),C.focus(),s||W(),0===h.length&&R(),O()}function B(){g=!1,S.classList.remove("open"),I.classList.remove("open")}function j(){v=0,A.style.display="none",A.textContent="0"}function N(){C.style.height="auto",C.style.height=Math.min(C.scrollHeight,100)+"px"}function O(){setTimeout(()=>{E.scrollTop=E.scrollHeight},100)}function R(){const e=`\n      <div class="aurora-chat-welcome">\n        <div class="aurora-chat-welcome-emoji">üåå</div>\n        <div class="aurora-chat-welcome-title">Welcome to Aurora Viking!</div>\n        <div class="aurora-chat-welcome-text">${n}</div>\n      </div>\n    `;E.innerHTML=e}function H(){if(0===h.length)return g&&R(),void(x.querySelector(".aurora-chat-quick-replies").style.display="flex");x.querySelector(".aurora-chat-quick-replies").style.display="none",E.innerHTML=h.map(e=>`\n      <div class="aurora-chat-message ${"inbound"===e.direction?"visitor":"staff"}">\n        <div class="aurora-chat-bubble">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/\n/g,"<br>")}(e.content)}</div>\n        <div class="aurora-chat-message-time">${function(e){const t=new Date(e),a=new Date,n=Math.floor((a-t)/864e5);return 0===n?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===n?"Yesterday "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):n<7?t.toLocaleDateString([],{weekday:"short"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})}(e.timestamp)}</div>\n      </div>\n    `).join(""),O()}function P(e){h.some(t=>t.id===e.id)||(h.push(e),b=e.id,q(),H(),"outbound"===e.direction&&(g&&!document.hidden||(v++,A.textContent=v>99?"99+":v.toString(),A.style.display="flex")))}function z(){const e=document.getElementById("aurora-visitor-name"),t=document.getElementById("aurora-visitor-email"),a=document.getElementById("aurora-visitor-booking");e&&e.value.trim()&&(u=e.value.trim()),t&&t.value.trim()&&(d=t.value.trim()),a&&a.value.trim()&&(m=a.value.trim().toUpperCase()),console.log("üìã Visitor info captured:",{name:u,email:d,booking:m,nameInputValue:e?.value,emailInputValue:t?.value,bookingInputValue:a?.value})}async function W(){k||(console.log("‚è≥ Waiting for auth..."),await L()),z();try{const e=firebase.firestore(),t=firebase.auth().currentUser?.uid||"anon_"+Date.now();s="ws_"+t.substring(0,12)+"_"+Date.now().toString(36);const a=await e.collection("customers").add({name:u||"Website Visitor",email:d||null,phone:null,source:"website_chat",sessionId:s,createdAt:firebase.firestore.FieldValue.serverTimestamp(),firstPageUrl:window.location.href,referrer:document.referrer||null,userAgent:navigator.userAgent||null});c=a.id;const n=await e.collection("conversations").add({customerId:c,customerName:u||"Website Visitor",customerEmail:d||null,channel:"website",subject:m?`Website Chat - ${m}`:"Website Chat",status:"active",hasUnread:!1,unreadCount:0,bookingIds:m?[m.toUpperCase()]:[],messageIds:[],lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessagePreview:"",createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),channelMetadata:{website:{sessionId:s,firstPageUrl:window.location.href,referrer:document.referrer||null,bookingRef:m||null}},inboxEmail:"website"});l=n.id,await e.collection("website_sessions").doc(s).set({sessionId:s,conversationId:l,customerId:c,visitorName:null,visitorEmail:null,bookingRef:null,firstPageUrl:window.location.href,currentPageUrl:window.location.href,referrer:document.referrer||null,userAgent:navigator.userAgent||null,isOnline:!0,lastSeen:firebase.firestore.FieldValue.serverTimestamp(),createdAt:firebase.firestore.FieldValue.serverTimestamp()}),q(),J(),console.log("üåå Chat session created via Firestore:",s)}catch(e){console.error("Error creating session:",e),K("Unable to connect. Please try again.")}}async function $(e){e.preventDefault();const t=C.value.trim();if(!t)return;C.value="",N(),z(),s||await W();const a="temp_"+Date.now();P({id:a,content:t,direction:"inbound",timestamp:(new Date).toISOString(),status:"sending"});try{const e=firebase.firestore(),n=await e.collection("messages").add({conversationId:l,customerId:c,channel:"website",direction:"inbound",content:t,timestamp:firebase.firestore.FieldValue.serverTimestamp(),status:"delivered",channelMetadata:{website:{sessionId:s,pageUrl:window.location.href}}}),r={lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessagePreview:t.substring(0,100),hasUnread:!0,unreadCount:firebase.firestore.FieldValue.increment(1),status:"active",customerName:u||"Website Visitor",updatedAt:firebase.firestore.FieldValue.serverTimestamp(),messageIds:firebase.firestore.FieldValue.arrayUnion(n.id)};d&&(r.customerEmail=d),m&&(r.bookingIds=firebase.firestore.FieldValue.arrayUnion(m.toUpperCase()),r["channelMetadata.website.bookingRef"]=m.toUpperCase(),r.subject="Website Chat - "+m.toUpperCase()),await e.collection("conversations").doc(l).update(r),await e.collection("website_sessions").doc(s).update({lastSeen:firebase.firestore.FieldValue.serverTimestamp(),isOnline:!0,visitorName:u||null,visitorEmail:d||null});const o=h.findIndex(e=>e.id===a);o>=0&&(h[o].id=n.id,h[o].status="sent",q()),console.log("‚úÖ Message sent via Firestore:",n.id)}catch(e){console.error("Error sending message:",e);const t=h.findIndex(e=>e.id===a);t>=0&&(h[t].status="failed",H()),K("Message failed to send. Tap to retry.")}}function J(){if(!l||f)return;const e=firebase.firestore();f=e.collection("messages").where("conversationId","==",l).where("channel","==","website").orderBy("timestamp","asc").onSnapshot(e=>{e.docChanges().forEach(e=>{if("added"===e.type){const t=e.doc,a=t.data();if("outbound"===a.direction){const e={id:t.id,content:a.content||"",direction:"outbound",timestamp:a.timestamp?.toDate?.()?.toISOString()||(new Date).toISOString(),status:"delivered"};h.some(t=>t.id===e.id)||(P(e),console.log("üì© Staff reply received:",t.id))}}})},e=>{console.error("Message listener error:",e),setTimeout(()=>J(),5e3)}),console.log("üëÇ Real-time message listener started for:",l)}function K(e){console.error("Chat Error:",e)}window.AuroraChat={open:_,close:B,toggle:D,identify:(e,t)=>{u=e,d=t,q(),s&&k&&M(`${i}/updateWebsiteSession`,{method:"POST",body:JSON.stringify({sessionId:s,visitorName:e,visitorEmail:t})}).catch(e=>console.error("Error updating visitor info:",e))},destroy:()=>{x&&x.parentNode&&x.parentNode.removeChild(x)}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",V):V()}();
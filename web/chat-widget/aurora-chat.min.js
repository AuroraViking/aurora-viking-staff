/**
 * Aurora Viking Chat Widget v1.0.0
 * (c) 2026 Aurora Viking - Northern Lights Tours
 * 
 * For full source, see: aurora-chat.js
 */
(function(){"use strict";const e=window.AURORA_CHAT_CONFIG||{},t=e.projectId||"aurora-viking-staff",n=e.apiKey||"AIzaSyDdCYDwnVw2IuWPaco_QUzGBMEz8ef2Zj4",o=e.greeting||"Hi! ðŸ‘‹ Ask us anything about Northern Lights tours!",s=e.quickReplies||["Tour availability?","What to wear?","Photo request","Rebooking"],i=`https://us-central1-${t}.cloudfunctions.net`;let r=null,a=null,c=null,l=null,d=null,h=[],u=!1,p=0,m=null,f=null,g=null,y=null,v=null,w=null;function b(){C(),_(),T(),sessionId&&conversationId&&E(),k(),console.log("ðŸŒŒ Aurora Chat Widget initialized")}function C(){try{const e=localStorage.getItem("aurora_chat_session");if(e){const t=JSON.parse(e);r=t.sessionId,a=t.conversationId,c=t.customerId,l=t.visitorName,d=t.visitorEmail,h=t.messages||[],m=t.lastMessageId}}catch(e){console.error("Error loading session:",e)}}function S(){try{localStorage.setItem("aurora_chat_session",JSON.stringify({sessionId:r,conversationId:a,customerId:c,visitorName:l,visitorEmail:d,messages:h.slice(-50),lastMessageId:m}))}catch(e){console.error("Error saving session:",e)}}function _(){f=document.createElement("div"),f.className="aurora-chat-widget",f.innerHTML=`<button class="aurora-chat-button" aria-label="Open chat"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg><span class="aurora-chat-badge" style="display: none;">0</span></button><div class="aurora-chat-window"><div class="aurora-chat-header"><div class="aurora-chat-logo"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div><div class="aurora-chat-header-info"><div class="aurora-chat-title">Aurora Viking</div><div class="aurora-chat-subtitle"><span class="aurora-chat-status"></span><span>We typically reply within minutes</span></div></div><button class="aurora-chat-close" aria-label="Close chat"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="aurora-chat-connection">Connection lost. Reconnecting...</div><div class="aurora-chat-messages"></div><div class="aurora-chat-quick-replies">${s.map(e=>`<button class="aurora-chat-quick-reply">${e}</button>`).join("")}</div><div class="aurora-chat-input-container"><form class="aurora-chat-input-form"><div class="aurora-chat-input-wrapper"><textarea class="aurora-chat-input" placeholder="Type your message..." rows="1" maxlength="2000"></textarea></div><button type="submit" class="aurora-chat-send" aria-label="Send message"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></form></div><div class="aurora-chat-footer">Powered by <a href="https://auroraviking.is" target="_blank" rel="noopener">Aurora Viking</a></div></div>`,document.body.appendChild(f),g=f.querySelector(".aurora-chat-button"),y=f.querySelector(".aurora-chat-window"),v=f.querySelector(".aurora-chat-messages"),w=f.querySelector(".aurora-chat-input"),_Badge=f.querySelector(".aurora-chat-badge"),x()}function T(){if(document.getElementById("aurora-chat-styles"))return;const e=document.createElement("link");e.id="aurora-chat-styles",e.rel="stylesheet",e.href=`https://${t}.web.app/chat-widget/aurora-chat.css`,document.head.appendChild(e)}function x(){g.addEventListener("click",I),f.querySelector(".aurora-chat-close").addEventListener("click",L);const e=f.querySelector(".aurora-chat-input-form");e.addEventListener("submit",R),w.addEventListener("input",j),w.addEventListener("keydown",e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),R(e))}),f.querySelectorAll(".aurora-chat-quick-reply").forEach(e=>{e.addEventListener("click",()=>{w.value=e.textContent,R(new Event("submit"))})}),document.addEventListener("visibilitychange",()=>{!document.hidden&&u&&M()})}function I(){u?L():A()}function A(){u=!0,y.classList.add("open"),g.classList.add("open"),M(),w.focus(),r||N(),0===h.length&&P(),D()}function L(){u=!1,y.classList.remove("open"),g.classList.remove("open")}function M(){p=0,_Badge.style.display="none",_Badge.textContent="0"}function O(){u&&!document.hidden||(p++,_Badge.textContent=p>99?"99+":p.toString(),_Badge.style.display="flex")}function j(){w.style.height="auto",w.style.height=Math.min(w.scrollHeight,100)+"px"}function D(){setTimeout(()=>{v.scrollTop=v.scrollHeight},100)}function P(){const e=`<div class="aurora-chat-welcome"><div class="aurora-chat-welcome-emoji">ðŸŒŒ</div><div class="aurora-chat-welcome-title">Welcome to Aurora Viking!</div><div class="aurora-chat-welcome-text">${o}</div></div>`;v.innerHTML=e}function z(){if(0===h.length)return void(u&&P());f.querySelector(".aurora-chat-quick-replies").style.display="none",v.innerHTML=h.map(e=>`<div class="aurora-chat-message ${"inbound"===e.direction?"visitor":"staff"}"><div class="aurora-chat-bubble">${q(e.content)}</div><div class="aurora-chat-message-time">${B(e.timestamp)}</div></div>`).join(""),D()}function H(e){h.some(t=>t.id===e.id)||(h.push(e),m=e.id,S(),z(),"outbound"===e.direction&&O())}async function N(){try{const e=await fetch(`${i}/createWebsiteSession`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pageUrl:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent})});if(!e.ok)throw new Error("Failed to create session");const t=await e.json();r=t.sessionId,a=t.conversationId,c=t.customerId,S(),E(),console.log("ðŸŒŒ Chat session created:",r)}catch(e){console.error("Error creating session:",e)}}function k(){r&&fetch(`${i}/updateWebsiteSession`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:r,currentPageUrl:window.location.href})}).catch(e=>console.error("Error tracking page:",e))}async function R(e){e.preventDefault();const t=w.value.trim();if(!t)return;if(w.value="",j(),r||await N(),!r)return;const n="temp_"+Date.now(),o={id:n,content:t,direction:"inbound",timestamp:(new Date).toISOString(),status:"sending"};H(o);try{const e=await fetch(`${i}/sendWebsiteMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:r,conversationId:a,content:t,visitorName:l,visitorEmail:d})});if(!e.ok)throw new Error("Failed to send message");const s=await e.json(),c=h.findIndex(e=>e.id===n);c>=0&&(h[c].id=s.messageId,h[c].status="sent",S())}catch(e){console.error("Error sending message:",e);const t=h.findIndex(e=>e.id===n);t>=0&&(h[t].status="failed",z())}}function E(){a&&U()}async function U(){if(!a)return;try{const e=`https://firestore.googleapis.com/v1/projects/${t}/databases/(default)/documents/messages?orderBy=timestamp&pageSize=50`,n=await fetch(e+`&where.fieldFilter.field.fieldPath=conversationId&where.fieldFilter.op=EQUAL&where.fieldFilter.value.stringValue=${a}`);if(n.ok){const e=await n.json();e.documents&&e.documents.map(e=>({id:e.name.split("/").pop(),content:e.fields.content?.stringValue||"",direction:e.fields.direction?.stringValue||"inbound",timestamp:e.fields.timestamp?.timestampValue||(new Date).toISOString(),status:e.fields.status?.stringValue||"sent"})).filter(e=>!h.some(t=>t.id===e.id)).sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)).forEach(e=>H(e))}}catch(e){console.error("Error polling messages:",e)}setTimeout(U,3e3)}function q(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/\n/g,"<br>")}function B(e){const t=new Date(e),n=new Date,o=Math.floor((n-t)/864e5);return 0===o?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===o?"Yesterday "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):o<7?t.toLocaleDateString([],{weekday:"short"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})}window.AuroraChat={open:A,close:L,toggle:I,identify:(e,t)=>{l=e,d=t,S()},destroy:()=>{f&&f.parentNode&&f.parentNode.removeChild(f)}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b()})();

